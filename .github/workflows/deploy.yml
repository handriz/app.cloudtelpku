# .github/workflows/deploy.yml
# Workflow ini akan mengotomatisasi proses deployment aplikasi Laravel ke VPS.

name: Deploy Laravel to VPS

on:
  push:
    branches:
      - main # Workflow akan berjalan setiap kali ada push ke branch 'main'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # Menggunakan runner Ubuntu terbaru yang disediakan GitHub

    steps:
      # Langkah 1: Checkout kode dari repositori GitHub
      - name: Checkout Code
        uses: actions/checkout@v3

      # Langkah 2: Tambahkan Host Key VPS ke known_hosts di runner
      - name: Add SSH Host Key to Known Hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_PUBLIC_HOST_KEY }}" | sed 's/\r$//' >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # Langkah 3: Menyiapkan SSH Agent
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- START: Caching Dependensi untuk Mempercepat Build ---
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor # Direktori yang akan di-cache
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: node_modules # Direktori yang akan di-cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }} 
          restore-keys: |
            ${{ runner.os }}-node-

      # --- END: Caching Dependensi ---

      # Langkah 4: Instalasi PHP Manual di runner GitHub Actions
      - name: Manual Setup PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
          # Instal PHP 8.3 dan ekstensi yang dibutuhkan untuk Laravel
          sudo apt-get install -y php8.3-cli php8.3-common php8.3-mysql php8.3-xml php8.3-curl php8.3-mbstring php8.3-zip php8.3-bcmath php8.3-gd
          sudo apt-get install -y composer
          php -v
          composer -V

      # Langkah 5: Menginstal Dependensi PHP (Composer) di runner
      - name: Install Composer Dependencies
        run: composer install --no-dev --optimize-autoloader

      # Langkah 6: Menyiapkan Node.js Environment di runner
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Langkah 7: Menginstal Dependensi Node.js (npm) di runner
      - name: Install Node.js Dependencies
        run: npm install

      # Langkah 8: Mengkompilasi Aset Frontend (CSS/JS) di runner
      - name: Build Frontend Assets
        run: npm run build

      # Langkah 9: Membuat file .env di runner (SEBELUM build)
      # - name: Create .env file
      #   ##run: printf '%s\n' "${{ secrets.DOT_ENV_CONTENT }}" > .env
      #   run: printf '%s\n' "${{ secrets.DOT_ENV_CONTENT }}" > .env
      #   env:
      #     DOT_ENV_CONTENT: ${{ secrets.DOT_ENV_CONTENT }}

      # Langkah 9: Deployment: Sinkronisasi File ke VPS menggunakan rsync
      - name: Sync Files to VPS using rsync directly
        run: |
          # Pastikan rsync terinstal di VPS Anda. Jika belum:
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "sudo apt-get update && sudo apt-get install -y rsync"
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "\
            sudo mkdir -p /var/www/app.cloudtelpku && \
            sudo chown -R ${{ secrets.VPS_USERNAME }}:www-data /var/www/app.cloudtelpku \
          "

          # âœ… versi aman: tidak menimpa izin dan ACL
          # rsync -avz --delete --exclude='.git' --exclude='.env' --exclude='storage/app/*' --exclude='storage/framework/*' --exclude='bootstrap/cache/*' -e "ssh -o StrictHostKeyChecking=yes" ${{ github.workspace }}/ ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/var/www/app.cloudtelpku/
          rsync -az --delete-delay --no-perms --no-owner --no-group \
            --exclude='.git' \
            --exclude='.env' \
            --exclude='storage/app/*' \
            --exclude='storage/framework/*' \
            --exclude='bootstrap/cache/*' \
            -e "ssh -o StrictHostKeyChecking=yes" \
            ${{ github.workspace }}/ \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/var/www/app.cloudtelpku/

      # Langkah 11: Jalankan Perintah Pasca-Deployment di VPS
      - name: Run Post-Deployment Commands on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            DEPLOY_PATH="/var/www/app.cloudtelpku"
            WEB_USER="www-data"
            SSH_USER="${{ secrets.VPS_USERNAME }}"
            cd $DEPLOY_PATH

            echo "Installing ACL package..."
            sudo apt-get install -y acl
            
            echo "Setting primary ownership..."
            sudo chown -R $SSH_USER:$WEB_USER storage bootstrap/cache

            echo "Applying ACL for persistent write permissions..."
            sudo setfacl -R -m u:$WEB_USER:rwx storage bootstrap/cache
            sudo setfacl -R -m g:$WEB_USER:rwx storage bootstrap/cache
            sudo setfacl -d -m u:$WEB_USER:rwx storage bootstrap/cache
            sudo setfacl -d -m g:$WEB_USER:rwx storage/bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod -R 755 public

            echo "File permissions set successfully."

            echo "Running database migrations and seeding..."
            php artisan migrate --force # Gunakan ini untuk update selanjutnya
            #php artisan db:seed --force # Jalankan seeder terpisah jika migrate:fresh tidak digunakan
            echo "Database migrations and seeding complete."
                       
            echo "Clearing Laravel cache..."
            php artisan config:clear
            php artisan cache:clear
            php artisan view:clear
            php artisan route:clear
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            echo "Laravel cache cleared."
            
            echo "Linking storage..."
            php artisan storage:link || true
            echo "Storage linked."
            
            echo "Restarting web server and PHP-FPM..."
            # sudo systemctl restart nginx
            sudo systemctl restart php8.3-fpm
            echo "Deployment completed successfully."

